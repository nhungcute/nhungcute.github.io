<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Google Drive Text File Editor</title>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <h2>Insert or Update Text File on Google Drive</h2>
  <textarea id="textContent" rows="10" cols="80">Hello from Google Drive!</textarea><br>
  <button onclick="handleClientLoad()">Sign in & Upload</button>

  <script>
    const CLIENT_ID = '451667163554-rrbvqoahepjlq35d634c09fgc8ssuofo.apps.googleusercontent.com'; // Replace with your client ID
    const API_KEY = 'AIzaSyDJddlVwOWA8vzdVNrcp70if4eOL30xjp0'; // Replace with your API key
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    let fileName = 'data.txt';

    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        scope: SCOPES
      }).then(() => {
        return gapi.auth2.getAuthInstance().signIn();
      }).then(() => {
        checkOrCreateFile(fileName);
      }).catch(error => {
        console.error('Error during init or sign-in', error);
      });
    }

    function checkOrCreateFile(fileName) {
      gapi.client.drive.files.list({
        q: `name='${fileName}' and mimeType='text/plain' and trashed=false`,
        fields: 'files(id, name)'
      }).then(response => {
        const files = response.result.files;
        const content = document.getElementById('textContent').value;
        if (files && files.length > 0) {
          updateTextFile(files[0].id, content);
        } else {
          uploadTextFile(content);
        }
      });
    }

    function uploadTextFile(content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const metadata = {
        name: fileName,
        mimeType: 'text/plain'
      };

      const accessToken = gapi.auth.getToken().access_token;
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', blob);

      fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({ Authorization: 'Bearer ' + accessToken }),
        body: form
      }).then(res => res.json())
        .then(val => {
          alert('File uploaded successfully!');
          console.log('Uploaded file:', val);
        });
    }

    function updateTextFile(fileId, content) {
      const blob = new Blob([content], { type: 'text/plain' });
      const metadata = {
        mimeType: 'text/plain'
      };

      const accessToken = gapi.auth.getToken().access_token;
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', blob);

      fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
        method: 'PATCH',
        headers: new Headers({ Authorization: 'Bearer ' + accessToken }),
        body: form
      }).then(res => res.json())
        .then(val => {
          alert('File updated successfully!');
          console.log('Updated file:', val);
        });
    }
  </script>
</body>
</html>
